pipeline {
    agent any

    environment {
        DOCKER_IMAGE = "booking-app"
        VERSION = "v1.0.0"
        CONTAINER_NAME = "booking-rel-v1-0-0"
        TEST_PORT = "8084"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
                bat 'echo Release Pipeline Started && dir'
            }
        }
        
        stage('Build') {
            steps {
                bat '''
                    echo Building Docker image...
                    docker build -t %DOCKER_IMAGE%:%VERSION% .
                    echo ✅ Image built: %DOCKER_IMAGE%:%VERSION%
                '''
            }
        }
        
        stage('Test') {
            steps {
                bat '''
                    echo Testing release...
                    docker run -d --name %CONTAINER_NAME% -p %TEST_PORT%:80 %DOCKER_IMAGE%:%VERSION%
                    ping 127.0.0.1 -n 11 > nul
                    
                    curl -f http://localhost:%TEST_PORT%
                    if errorlevel 1 (
                        echo ❌ TEST FAILED
                        exit /b 1
                    )
                    echo ✅ TEST PASSED
                    
                    docker stop %CONTAINER_NAME%
                    docker rm %CONTAINER_NAME%
                '''
            }
        }
        
        stage('Archive') {
            steps {
                bat '''
                    mkdir release-artifacts 2>nul
                    echo "RELEASE: %VERSION%" > release-artifacts\\release.txt
                    echo "Date: %DATE% %TIME%" >> release-artifacts\\release.txt
                    echo "Status: PASSED" >> release-artifacts\\release.txt
                    docker images %DOCKER_IMAGE% > release-artifacts\\images.txt
                    echo ✅ Artefacts created
                '''
                archiveArtifacts artifacts: 'release-artifacts/**/*'
            }
        }
    }
    
    post {
        success {
            echo '✅ RELEASE PIPELINE SUCCESS'
        }
        failure {
            echo '❌ RELEASE PIPELINE FAILED'
        }
    }
}


       
