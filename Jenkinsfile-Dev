pipeline {
    agent any
    
    environment {
        BUILD_TAG = "dev-${BUILD_NUMBER}"
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
                bat 'dir'
            }
        }
        
        stage('Setup') {
            steps {
                bat '''
                    echo === SETUP ===
                    docker --version
                    echo Build Tag: %BUILD_TAG%
                    echo Build Number: %BUILD_NUMBER%
                '''
            }
        }
        
        stage('Build Docker Images') {
            parallel {
                stage('Build Standard') {
                    steps {
                        bat '''
                            echo 1/3: Building STANDARD (default)...
                            docker build -t booking-app:%BUILD_TAG%-standard .
                            echo ✅ Standard done
                        '''
                    }
                }
                stage('Build Production') {
                    steps {
                        bat '''
                            echo 2/3: Building PRODUCTION target...
                            docker build --target production -t booking-app:%BUILD_TAG%-production .
                            echo ✅ Production done
                        '''
                    }
                }
                stage('Build Debug') {
                    steps {
                        bat '''
                            echo 3/3: Building DEBUG target...
                            docker build --target debug -t booking-app:%BUILD_TAG%-debug .
                            echo ✅ Debug done
                        '''
                    }
                }
            }
            
            post {
                success {
                    bat '''
                        echo === IMAGES CREATED ===
                        docker images --format "{{.Tag}}\t{{.Size}}" | findstr booking-app
                        echo === SIZE COMPARISON ===
                        docker images --format "{{.Tag}}: {{.Size}}" | findstr %BUILD_TAG%
                    '''
                }
            }
        }
        
        stage('Run Container') {
            steps {
                bat '''
                    echo === RUNNING CONTAINER ===
                    docker run -d --name booking-%BUILD_NUMBER% -p 8080:80 booking-app:%BUILD_TAG%-standard
                    timeout /t 10 /nobreak >nul
                    echo Container started on port 8080
                '''
            }
        }
        
        stage('Smoke Test') {
            steps {
                bat '''
                    echo === SMOKE TEST ===
                    curl -f http://localhost:8080
                    if errorlevel 1 (
                        echo ❌ TEST FAILED: Cannot reach container
                        exit /b 1
                    )
                    echo ✅ TEST PASSED: Container is responding
                '''
            }
        }
        
        stage('Archive') {
            steps {
                bat '''
                    mkdir artifacts 2>nul
                    
                    echo Build Report > artifacts\\report.txt
                    echo ============ >> artifacts\\report.txt
                    echo Build Number: %BUILD_NUMBER% >> artifacts\\report.txt
                    echo Build Tag: %BUILD_TAG% >> artifacts\\report.txt
                    echo Date: %DATE% %TIME% >> artifacts\\report.txt
                    echo. >> artifacts\\report.txt
                    
                    echo Docker Images Created: >> artifacts\\report.txt
                    docker images --format "- {{.Tag}} ({{.Size}})" | findstr %BUILD_TAG% >> artifacts\\report.txt
                    
                    echo. >> artifacts\\report.txt
                    echo Test Result: PASSED >> artifacts\\report.txt
                '''
                archiveArtifacts artifacts: 'artifacts/**/*'
            }
        }
        
        stage('Cleanup') {
            steps {
                bat '''
                    echo === CLEANUP ===
                    docker stop booking-%BUILD_NUMBER% 2>nul || echo Already stopped
                    docker rm booking-%BUILD_NUMBER% 2>nul || echo Already removed
                    
                    echo Removing temporary images...
                    docker image prune -f
                    
                    echo Cleanup done
                '''
            }
        }
    }
    
    post {
        success {
            echo '✅ PIPELINE SUCCESS - All requirements met!'
            echo '✓ 3 parallel Docker builds'
            echo '✓ Multi-stage optimization (production vs debug)'
            echo '✓ Smoke tests executed'
            echo '✓ Artifacts archived'
        }
        failure {
            echo '❌ PIPELINE FAILED'
            archiveArtifacts artifacts: '**/*.log,**/*.txt', allowEmptyArchive: true
        }
    }
}
