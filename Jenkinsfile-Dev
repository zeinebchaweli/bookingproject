pipeline {
    agent any

    environment {
        IMAGE_NAME = "booking-app"
        IMAGE_NODE20 = "booking-app:node20-dev-${BUILD_NUMBER}"
        IMAGE_NODE18 = "booking-app:node18-dev-${BUILD_NUMBER}"
        CONTAINER = "booking-dev-${BUILD_NUMBER}"
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Setup') {
            steps {
                bat '''
                    docker --version
                    for /f "tokens=*" %%i in ('docker ps -aq --filter "name=booking-dev"') do (
                        docker stop %%i 2>nul
                        docker rm %%i 2>nul
                    )
                '''
            }
        }

        stage('Build Docker Images') {
            parallel {

                stage('Build Node 20') {
                    steps {
                        bat '''
                            echo === BUILD NODE 20 ===
                            docker build -t %IMAGE_NODE20% .
                        '''
                    }
                }

                stage('Build Node 18 (Compatibility)') {
                    steps {
                        catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
                            bat '''
                                echo === BUILD NODE 18 ===
                                docker build -t %IMAGE_NODE18% .
                            '''
                        }
                    }
                }
            }
        }

        stage('Run Container') {
            steps {
                bat '''
                    docker run -d --name %CONTAINER% -p 8080:80 %IMAGE_NODE20%
                    ping 127.0.0.1 -n 6 > nul
                '''
            }
        }

        stage('Smoke Test') {
            steps {
                bat '''
                    curl -f http://localhost:8080 || exit /b 1
                '''
            }
        }

        stage('Cleanup') {
            steps {
                bat '''
                    docker stop %CONTAINER% 2>nul
                    docker rm %CONTAINER% 2>nul
                '''
            }
        }
    }

    post {
        success {
            echo '✅ PIPELINE DEV SUCCESS'
        }
        failure {
            echo '❌ PIPELINE DEV FAILED'
        }
    }
}
