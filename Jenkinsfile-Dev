pipeline {
    agent any
    
    environment {
        BUILD_TAG = "dev-${BUILD_NUMBER}"
    }
    
    stages {
        // STAGE 1: Checkout
        stage('Checkout SCM') {
            steps {
                checkout scm
                bat 'echo Checkout done && dir'
            }
        }
        
        // STAGE 2: Setup
        stage('Setup') {
            steps {
                bat '''
                    echo === SETUP ===
                    docker --version
                    echo Build: %BUILD_NUMBER%
                    echo Cleaning old containers...
                    
                    rem Nettoyer les anciens conteneurs booking-dev
                    for /f "tokens=*" %%i in ('docker ps -aq --filter "name=booking-dev"') do (
                        docker stop %%i 2>nul || echo Already stopped
                        docker rm %%i 2>nul || echo Already removed
                    )
                    
                    echo Setup complete
                '''
            }
        }
        
        // STAGE 3: Build Docker (PARALLEL)
        stage('Build Docker Images') {
            parallel {
                stage('Build Image 1') {
                    steps {
                        bat '''
                            echo Building Docker image 1...
                            docker build -t booking-app:%BUILD_TAG%-1 .
                            echo ✅ Image 1 built
                        '''
                    }
                }
                stage('Build Image 2') {
                    steps {
                        bat '''
                            echo Building Docker image 2...
                            docker build -t booking-app:%BUILD_TAG%-2 .
                            echo ✅ Image 2 built
                        '''
                    }
                }
                stage('Build Image 3') {
                    steps {
                        bat '''
                            echo Building Docker image 3...
                            docker build -t booking-app:%BUILD_TAG%-3 .
                            echo ✅ Image 3 built
                        '''
                    }
                }
            }
            
            post {
                success {
                    bat '''
                        echo ================================
                        echo DOCKER IMAGES CREATED:
                        echo ================================
                        docker images booking-app --format "table {{.Tag}}\t{{.Size}}"
                        echo ================================
                    '''
                }
            }
        }
        
        // STAGE 4: Run Container
        stage('Run Container') {
            steps {
                bat '''
                    echo === RUNNING CONTAINER ===
                    docker run -d --name booking-dev-%BUILD_NUMBER% -p 8080:80 booking-app:%BUILD_TAG%-1
                    timeout /t 10 /nobreak >nul
                    echo Container started on port 8080
                '''
            }
        }
        
        // STAGE 5: Smoke Test
        stage('Smoke Test') {
            steps {
                bat '''
                    echo === SMOKE TEST ===
                    echo Testing HTTP endpoint...
                    curl -f http://localhost:8080
                    if errorlevel 1 (
                        echo ❌ SMOKE TEST FAILED
                        exit /b 1
                    )
                    echo ✅ SMOKE TEST PASSED
                '''
            }
        }
        
        // STAGE 6: Archive Artifacts
        stage('Archive Artifacts') {
            steps {
                bat '''
                    mkdir artifacts 2>nul
                    
                    echo === CREATING ARTIFACTS ===
                    
                    echo JENKINS BUILD REPORT > artifacts\\build-report.txt
                    echo ===================== >> artifacts\\build-report.txt
                    echo Build: %BUILD_NUMBER% >> artifacts\\build-report.txt
                    echo Date: %DATE% %TIME% >> artifacts\\build-report.txt
                    echo Status: PASSED >> artifacts\\build-report.txt
                    echo. >> artifacts\\build-report.txt
                    
                    echo DOCKER IMAGES: >> artifacts\\build-report.txt
                    docker images booking-app --format "- {{.Tag}} ({{.Size}})" >> artifacts\\build-report.txt
                    
                    echo ✅ All artifacts created
                '''
                
                archiveArtifacts artifacts: 'artifacts/**/*', fingerprint: true
            }
        }
        
        // STAGE 7: Cleanup
        stage('Cleanup') {
            steps {
                bat '''
                    echo === CLEANUP ===
                    docker stop booking-dev-%BUILD_NUMBER% 2>nul || echo Already stopped
                    docker rm booking-dev-%BUILD_NUMBER% 2>nul || echo Already removed
                    echo ✅ Cleanup completed
                '''
            }
        }
    }
    
    post {
        always {
            echo "Pipeline status: ${currentBuild.currentResult}"
        }
        success {
            echo '✅ PIPELINE SUCCESS - All requirements met!'
            echo '✓ 3 parallel Docker builds'
            echo '✓ Docker multi-stage build'
            echo '✓ Smoke tests executed'
            echo '✓ Artifacts archived'
        }
        failure {
            echo '❌ PIPELINE FAILED'
            archiveArtifacts artifacts: '**/*.log,**/*.txt', allowEmptyArchive: true
        }
    }
}
