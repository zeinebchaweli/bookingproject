pipeline {
    agent any
    
    environment {
        DOCKER_IMAGE = "booking-app"
        DOCKER_TAG = "dev-${BUILD_NUMBER}"
        CONTAINER_NAME = "booking-dev-${BUILD_NUMBER}"
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo '=== Stage 1: Checkout ==='
                git branch: 'dev',
                    url: 'https://github.com/zeinebchaweli/bookingproject.git'
                bat 'dir'
            }
        }
        
        stage('Setup') {
            steps {
                echo '=== Stage 2: Setup ==='
                bat '''
                    docker --version
                    docker system prune -f
                '''
            }
        }
        
        stage('Build') {
            parallel {
                stage('Build Standard') {
                    steps {
                        bat '''
                            docker build -t %DOCKER_IMAGE%:%DOCKER_TAG%-standard .
                            echo [PASSED] Standard build
                        '''
                    }
                }
                stage('Build Optimized') {
                    steps {
                        bat '''
                            docker build -t %DOCKER_IMAGE%:%DOCKER_TAG%-optimized --compress .
                            echo [PASSED] Optimized build
                        '''
                    }
                }
                stage('Build Debug') {
                    steps {
                        bat '''
                            docker build -t %DOCKER_IMAGE%:%DOCKER_TAG%-debug --target builder .
                            echo [PASSED] Debug build
                        '''
                    }
                }
            }
        }
        
        stage('Run') {
            steps {
                echo '=== Stage 4: Run ==='
                bat '''
                    docker run -d --name %CONTAINER_NAME% -p 8083:80 %DOCKER_IMAGE%:%DOCKER_TAG%-standard
                    timeout /t 15 /nobreak
                    docker ps | findstr %CONTAINER_NAME%
                '''
            }
        }
        
stage('Smoke Test') {
            steps {
                echo '=== Stage 5: Tests ==='
                bat '''
                    curl -f http://localhost:8083 || exit /b 1
                    echo [PASSED] HTTP test
                    docker inspect %CONTAINER_NAME% --format="{{.State.Status}}" | findstr running || exit /b 1
                    echo [PASSED] Container health
                    echo ALL TESTS PASSED
                '''
            } 
        }
        
        stage('Archive Artifacts') {
            steps {
                echo '=== Stage 6: Archive ==='
                bat '''
                    if not exist artifacts\\logs mkdir artifacts\\logs
                    if not exist artifacts\\reports mkdir artifacts\\reports
                    docker logs %CONTAINER_NAME% > artifacts\\logs\\app.txt 2>&1
                    docker images %DOCKER_IMAGE% > artifacts\\reports\\images.txt
                    echo Build %BUILD_NUMBER% SUCCESS > artifacts\\reports\\report.txt
                '''
                archiveArtifacts artifacts: 'artifacts/**/*'
            }
        }
        
        stage('Cleanup') {
            steps {
                bat '''
                    docker stop %CONTAINER_NAME% || echo OK
                    docker rm %CONTAINER_NAME% || echo OK
                '''
            }
        }
    }
    
    post {
        success {
            echo 'âœ… Dev Pipeline SUCCESS'
        }
    }
}
