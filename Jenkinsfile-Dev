pipeline {
    agent any

    environment {
        IMAGE_NAME = "booking-app"
        IMAGE_NODE20 = "booking-app:node20-dev-${BUILD_NUMBER}"
        IMAGE_NODE18 = "booking-app:node18-dev-${BUILD_NUMBER}"
        CONTAINER = "booking-dev-${BUILD_NUMBER}"
    }

    stages {

        stage('Checkout SCM') {
            steps {
                checkout scm
                bat 'echo Checkout done'
            }
        }

        stage('Setup') {
            steps {
                bat '''
                    echo === SETUP ===
                    docker --version
                    echo Cleaning old containers...
                    for /f "tokens=*" %%i in ('docker ps -aq --filter "name=booking-dev"') do (
                        docker stop %%i 2>nul
                        docker rm %%i 2>nul
                    )
                '''
            }
        }

        stage('Build Docker Images (Parallel)') {
            parallel {

                stage('Build with Node 20') {
                    steps {
                        bat '''
                            echo === BUILD NODE 20 ===
                            docker build -t %IMAGE_NODE20% .
                        '''
                    }
                }

                stage('Build with Node 18 (Compatibility Test)') {
                    steps {
                        catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
                            bat '''
                                echo === BUILD NODE 18 ===
                                docker build -t %IMAGE_NODE18% .
                            '''
                        }
                    }
                }
            }
        }

        stage('Run Container') {
            steps {
                bat '''
                    echo === RUN CONTAINER ===
                    docker run -d --name %CONTAINER% -p 8080:80 %IMAGE_NODE20%
                    ping 127.0.0.1 -n 6 > nul
                '''
            }
        }

        stage('Smoke Test') {
            steps {
                bat '''
                    echo === SMOKE TEST ===
                    curl -f http://localhost:8080 || exit /b 1
                    echo Smoke test PASSED
                '''
            }
        }

        stage('Archive Artifacts') {
            steps {
                bat '''
                    mkdir artifacts 2>nul
                    echo Build %BUILD_NUMBER% SUCCESS > artifacts\\build.txt
                    echo Image: %IMAGE_NODE20% >> artifacts\\build.txt
                '''
                archiveArtifacts artifacts: 'artifacts/**/*', fingerprint: true
            }
        }

        stage('Cleanup') {
            steps {
                bat '''
                    docker stop %CONTAINER% 2>nul
                    docker rm %CONTAINER% 2>nul
                '''
            }
        }
    }

    post {
        success {
            echo '✅ PIPELINE DEV SUCCESS'
        }
        failure {
            echo '❌ PIPELINE DEV FAILED'
        }
        always {
            echo "Pipeline status: ${currentBuild.currentResult}"
        }
    }
}
