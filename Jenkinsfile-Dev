pipeline {
    agent any
    
    environment {
        BUILD_TAG = "dev-${BUILD_NUMBER}"
    }
    
    stages {
        // STAGE 1: Checkout
        stage('Checkout SCM') {
            steps {
                checkout scm
                bat 'echo Checkout done && dir'
            }
        }
        
        // STAGE 2: Setup
        stage('Setup') {
            steps {
                bat '''
                    echo === SETUP ===
                    docker --version
                    echo Build: %BUILD_NUMBER%
                    echo Cleaning old containers...
                    
                    rem Nettoyer les anciens conteneurs booking-dev
                    for /f "tokens=*" %%i in ('docker ps -aq --filter "name=booking-dev"') do (
                        docker stop %%i 2>nul || echo Already stopped
                        docker rm %%i 2>nul || echo Already removed
                    )
                    
                    echo Setup complete
                '''
            }
        }
        
       // STAGE 3: Build Docker Images (PARALLEL BY RUNTIME)
stage('Build Docker Images (Parallel Runtime)') {
    parallel {

        stage('Build with Node 18') {
            steps {
                bat '''
                    echo === BUILD WITH NODE 18 ===
                    docker build ^
                      --build-arg NODE_VERSION=18 ^
                      -t booking-app:%BUILD_TAG%-node18 .
                    echo ✅ Image Node 18 built
                '''
            }
        }

        stage('Build with Node 20') {
            steps {
                bat '''
                    echo === BUILD WITH NODE 20 ===
                    docker build ^
                      --build-arg NODE_VERSION=20 ^
                      -t booking-app:%BUILD_TAG%-node20 .
                    echo ✅ Image Node 20 built
                '''
            }
        }
    }

    post {
        success {
            bat '''
                echo ================================
                echo DOCKER IMAGES CREATED (PARALLEL):
                echo ================================
                docker images booking-app --format "table {{.Tag}}\t{{.Size}}"
                echo ================================
            '''
        }
    }
}

        
stage('Run Container') {
    steps {
        bat '''
            echo === RUNNING CONTAINER ===
            rem Libérer le port 8080 si utilisé
            for /f "tokens=*" %%i in ('docker ps -aq --filter "publish=8080"') do (
                docker stop %%i 2>nul || echo OK
                docker rm %%i 2>nul || echo OK
            )
            
            docker run -d --name booking-dev-%BUILD_NUMBER% -p 8080:80 booking-app:%BUILD_TAG%-1
            
            rem Attendre avec ping (plus fiable)
            echo Waiting for container to start...
            ping 127.0.0.1 -n 11 > nul
            
            echo Container started on port 8080
        '''
    }
}

stage('Smoke Test') {
    steps {
        bat '''
            echo === SMOKE TEST ===
            echo Testing HTTP endpoint...
            curl -f http://localhost:8080
            if errorlevel 1 (
                echo ❌ SMOKE TEST FAILED
                exit /b 1
            )
            echo ✅ SMOKE TEST PASSED
        '''
    }
}
        
        // STAGE 6: Archive Artifacts
        stage('Archive Artifacts') {
            steps {
                bat '''
                    mkdir artifacts 2>nul
                    
                    echo === CREATING ARTIFACTS ===
                    
                    echo JENKINS BUILD REPORT > artifacts\\build-report.txt
                    echo ===================== >> artifacts\\build-report.txt
                    echo Build: %BUILD_NUMBER% >> artifacts\\build-report.txt
                    echo Date: %DATE% %TIME% >> artifacts\\build-report.txt
                    echo Status: PASSED >> artifacts\\build-report.txt
                    echo. >> artifacts\\build-report.txt
                    
                    echo DOCKER IMAGES: >> artifacts\\build-report.txt
                    docker images booking-app --format "- {{.Tag}} ({{.Size}})" >> artifacts\\build-report.txt
                    
                    echo ✅ All artifacts created
                '''
                
                archiveArtifacts artifacts: 'artifacts/**/*', fingerprint: true
            }
        }
        
        // STAGE 7: Cleanup
        stage('Cleanup') {
            steps {
                bat '''
                    echo === CLEANUP ===
                    docker stop booking-dev-%BUILD_NUMBER% 2>nul || echo Already stopped
                    docker rm booking-dev-%BUILD_NUMBER% 2>nul || echo Already removed
                    echo ✅ Cleanup completed
                '''
            }
        }
    }
    
    post {
        always {
            echo "Pipeline status: ${currentBuild.currentResult}"
        }
        success {
            echo '✅ PIPELINE SUCCESS - All requirements met!'
            echo '✓ 3 parallel Docker builds'
            echo '✓ Docker multi-stage build'
            echo '✓ Smoke tests executed'
            echo '✓ Artifacts archived'
        }
        failure {
            echo '❌ PIPELINE FAILED'
            archiveArtifacts artifacts: '**/*.log,**/*.txt', allowEmptyArchive: true
        }
    }
}
