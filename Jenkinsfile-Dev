pipeline {
    agent any
    
    environment {
        CONTAINER_NAME = "booking-dev-${BUILD_NUMBER}"
        IMAGE_NAME = "booking-app:dev-${BUILD_NUMBER}"
        PORT = "8083"
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo '=== Stage 1: Checkout ==='
                git branch: 'dev', url: 'https://github.com/zeinebchaweli/bookingproject.git'
                bat 'dir'
            }
        }
        
        stage('Setup') {
            steps {
                echo '=== Stage 2: Setup ==='
                bat '''
                    docker --version
                    docker system prune -f
                '''
            }
        }
        
        stage('Pre-Cleanup') {
            steps {
                echo '=== Stage 2.5: Pre-Cleanup ==='
                bat '''
                    echo Cleaning up any existing containers on port %PORT%...
                    FOR /F "tokens=*" %%i IN ('docker ps -aq --filter "name=booking-dev"') DO (
                        docker stop %%i 2>nul || echo Container already stopped
                        docker rm %%i 2>nul || echo Container already removed
                    )
                    echo Cleanup complete
                '''
            }
        }
        
        stage('Build') {
            parallel {
                stage('Build Standard') {
                    steps {
                        bat '''
                            docker build -t %IMAGE_NAME%-standard .
                            echo [PASSED] Standard build
                        '''
                    }
                }
                stage('Build Optimized') {
                    steps {
                        bat '''
                            docker build -t %IMAGE_NAME%-optimized --compress .
                            echo [PASSED] Optimized build
                        '''
                    }
                }
                stage('Build Debug') {
                    steps {
                        bat '''
                            docker build -t %IMAGE_NAME%-debug --target builder .
                            echo [PASSED] Debug build
                        '''
                    }
                }
            }
        }
        
        stage('Run') {
            steps {
                echo '=== Stage 4: Run ==='
                bat '''
                    echo Starting container %CONTAINER_NAME%...
                    docker run -d --name %CONTAINER_NAME% -p %PORT%:80 %IMAGE_NAME%-standard
                    
                    echo Waiting for container to start...
                    ping 127.0.0.1 -n 16 > nul
                    
                    echo Verifying container is running...
                    docker ps | findstr %CONTAINER_NAME%
                    echo [PASSED] Container is running
                '''
            }
        }
        
        stage('Smoke Test') {
            steps {
                echo '=== Stage 5: Smoke Tests ==='
                bat '''
                    echo =========================================
                    echo SMOKE TEST SUITE
                    echo =========================================
                    echo [TEST] Checking HTTP endpoint...
                    curl -f http://localhost:%PORT% || exit /b 1
                    echo [PASSED] HTTP test
                    echo.
                    echo [TEST] Checking container health...
                    docker inspect %CONTAINER_NAME% --format="{{.State.Status}}" | findstr running || exit /b 1
                    echo [PASSED] Container health
                    echo.
                    echo =========================================
                    echo ✅ ALL TESTS PASSED
                    echo =========================================
                '''
            }
        }
        
        stage('Archive Artifacts') {
            steps {
                echo '=== Stage 6: Archive Artifacts ==='
                bat '''
                    if not exist "artifacts" mkdir artifacts
                    echo Build Number: %BUILD_NUMBER% > artifacts\\build-info.txt
                    echo Container: %CONTAINER_NAME% >> artifacts\\build-info.txt
                    echo Image: %IMAGE_NAME%-standard >> artifacts\\build-info.txt
                    echo Port: %PORT% >> artifacts\\build-info.txt
                    echo Build Date: %DATE% %TIME% >> artifacts\\build-info.txt
                    echo [PASSED] Artifacts created
                '''
                archiveArtifacts artifacts: 'artifacts/**/*', allowEmptyArchive: true
            }
        }
        
        stage('Cleanup') {
            steps {
                echo '=== Stage 7: Cleanup ==='
                bat '''
                    echo Stopping container...
                    docker stop %CONTAINER_NAME% || echo Container already stopped
                    
                    echo Removing container...
                    docker rm %CONTAINER_NAME% || echo Container already removed
                    
                    echo Cleanup complete
                '''
            }
        }
    }
    
    post {
        success {
            echo '✅ Dev Pipeline SUCCESS'
        }
        failure {
            echo '❌ Dev Pipeline FAILED'
        }
        always {
            echo '=== Pipeline Completed ==='
        }
    }
}
