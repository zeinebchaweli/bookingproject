
pipeline {
    agent any
    
    environment {
        BUILD_TAG = "dev-${BUILD_NUMBER}"
        CONTAINER_PREFIX = "booking-${BUILD_NUMBER}"
        IMAGE_NAME = "booking-app"
    }
    
    stages {
        // STAGE 1: Checkout
        stage('Checkout SCM') {
            steps {
                checkout scm
            }
        }
        
        // STAGE 2: Setup
        stage('Setup') {
            steps {
                bat '''
                    echo === ENVIRONMENT ===
                    docker --version
                    node --version 2>nul || echo "Node not in PATH"
                    echo.
                    echo === WORKSPACE ===
                    dir
                '''
            }
        }
        
        // STAGE 3: Build Docker (PARALLEL - Exigence du projet)
        stage('Build Docker Images') {
            parallel {
                stage('Build Standard') {
                    steps {
                        bat '''
                            echo Building standard image (default target)...
                            docker build -t %IMAGE_NAME%:%BUILD_TAG%-standard .
                            echo ✅ Standard image built
                        '''
                    }
                }
                stage('Build Optimized') {
                    steps {
                        bat '''
                            echo Building optimized production image...
                            docker build --target production -t %IMAGE_NAME%:%BUILD_TAG%-optimized .
                            echo ✅ Optimized image built
                        '''
                    }
                }
                stage('Build Debug') {
                    steps {
                        bat '''
                            echo Building debug image...
                            docker build --target debug -t %IMAGE_NAME%:%BUILD_TAG%-debug .
                            echo ✅ Debug image built
                        '''
                    }
                }
            }
            
            post {
                success {
                    bat '''
                        echo ================================
                        echo IMAGE SIZE REPORT (Pour votre rapport)
                        echo ================================
                        docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" | findstr booking-app
                        echo ================================
                    '''
                }
            }
        }
        
        // STAGE 4: Run Containers
        stage('Run Containers') {
            parallel {
                stage('Run Standard') {
                    steps {
                        bat '''
                            echo Starting standard container...
                            docker run -d --name %CONTAINER_PREFIX%-std -p 8080:80 %IMAGE_NAME%:%BUILD_TAG%-standard
                            timeout /t 5 /nobreak >nul
                            echo Container started on port 8080
                        '''
                    }
                }
                stage('Run Optimized') {
                    steps {
                        bat '''
                            echo Starting optimized container...
                            docker run -d --name %CONTAINER_PREFIX%-opt -p 8081:80 %IMAGE_NAME%:%BUILD_TAG%-optimized
                            timeout /t 5 /nobreak >nul
                            echo Container started on port 8081
                        '''
                    }
                }
            }
        }
        
        // STAGE 5: Smoke Tests (Exigence: Passed/Failed)
        stage('Smoke Tests') {
            steps {
                bat '''
                    echo ================================
                    echo SMOKE TEST SUITE
                    echo ================================
                    
                    echo [TEST 1] Checking standard container...
                    curl -f http://localhost:8080 && (
                        echo ✅ Standard: HTTP 200 OK
                        echo "STANDARD: PASSED" > test-results.txt
                    ) || (
                        echo ❌ Standard: HTTP FAILED
                        echo "STANDARD: FAILED" > test-results.txt
                        exit /b 1
                    )
                    
                    echo.
                    echo [TEST 2] Checking optimized container...
                    curl -f http://localhost:8081 && (
                        echo ✅ Optimized: HTTP 200 OK
                        echo "OPTIMIZED: PASSED" >> test-results.txt
                    ) || (
                        echo ❌ Optimized: HTTP FAILED
                        echo "OPTIMIZED: FAILED" >> test-results.txt
                        exit /b 1
                    )
                    
                    echo.
                    echo [TEST 3] Container status verification...
                    docker ps --format "table {{.Names}}\t{{.Status}}" | findstr %CONTAINER_PREFIX%
                    
                    echo.
                    echo ================================
                    echo ✅ ALL SMOKE TESTS PASSED
                    echo ================================
                '''
            }
        }
        
        // STAGE 6: Archive Artifacts (Exigence)
        stage('Archive Artifacts') {
            steps {
                bat '''
                    mkdir artifacts 2>nul
                    
                    echo === CREATING ARTIFACTS ===
                    
                    # 1. Build info
                    echo "JENKINS BUILD ARTIFACTS" > artifacts\\build-report.md
                    echo "=======================" >> artifacts\\build-report.md
                    echo "" >> artifacts\\build-report.md
                    echo "**Pipeline:** Dev" >> artifacts\\build-report.md
                    echo "**Build:** %BUILD_NUMBER%" >> artifacts\\build-report.md
                    echo "**Date:** %DATE% %TIME%" >> artifacts\\build-report.md
                    echo "" >> artifacts\\build-report.md
                    echo "**Docker Images Created:**" >> artifacts\\build-report.md
                    docker images --format "- \`{{.Tag}}\` ({{.Size}})" | findstr booking-app >> artifacts\\build-report.md
                    
                    # 2. Test results
                    copy test-results.txt artifacts\\ 2>nul || echo No test results
                    
                    # 3. Docker info
                    docker info > artifacts\\docker-info.txt
                    
                    # 4. Image inspection
                    docker inspect %IMAGE_NAME%:%BUILD_TAG%-optimized > artifacts\\image-details.json
                    
                    # 5. Size comparison table (important pour le rapport)
                    echo "IMAGE SIZE COMPARISON" > artifacts\\size-comparison.txt
                    echo "=====================" >> artifacts\\size-comparison.txt
                    docker images --format "{{.Tag}};{{.Size}}" | findstr booking-app > artifacts\\sizes.csv
                    
                    echo ✅ Artifacts created
                '''
                
                // Archivage Jenkins
                archiveArtifacts artifacts: 'artifacts/**/*', fingerprint: true
                
                // Archive aussi les logs de console
                archiveArtifacts artifacts: '**/*.log', allowEmptyArchive: true
            }
        }
        
        // STAGE 7: Cleanup (Recommandé)
        stage('Cleanup') {
            steps {
                bat '''
                    echo === CLEANUP ===
                    
                    echo Stopping containers...
                    docker stop %CONTAINER_PREFIX%-std 2>nul || echo "Container already stopped"
                    docker stop %CONTAINER_PREFIX%-opt 2>nul || echo "Container already stopped"
                    
                    echo Removing containers...
                    docker rm %CONTAINER_PREFIX%-std 2>nul || echo "Container already removed"
                    docker rm %CONTAINER_PREFIX%-opt 2>nul || echo "Container already removed"
                    
                    echo Removing unused images...
                    docker image prune -f
                    
                    echo ✅ Cleanup completed
                '''
            }
        }
    }
    
    post {
        always {
            echo "=== PIPELINE COMPLETED ==="
            echo "Status: ${currentBuild.currentResult}"
            echo "Duration: ${currentBuild.durationString}"
            echo "URL: ${env.BUILD_URL}"
            
            // Archive le log complet
            script {
                def log = currentBuild.rawBuild.getLog(200).join('\n')
                writeFile file: 'artifacts/full-pipeline-log.txt', text: log
            }
        }
        success {
            echo '✅ PROJECT REQUIREMENTS MET:'
            echo '   ✓ 3 parallel Docker builds'
            echo '   ✓ Multi-stage optimization'
            echo '   ✓ Smoke tests (Passed/Failed)'
            echo '   ✓ Artefacts archived'
            echo '   ✓ Proper Git workflow'
        }
        failure {
            echo '❌ PIPELINE FAILED'
            echo 'Check the logs above for details'
            
            // Archive même en cas d'échec
            archiveArtifacts artifacts: '**/*.txt,**/*.log', allowEmptyArchive: true
        }
    }
}
