pipeline {
    agent any
    
    stages {
        // STAGE 1: Checkout
        stage('Checkout') {
            steps {
                checkout scm
                bat 'echo Checkout PR done && dir'
            }
        }
        
        // STAGE 2: Build Docker
        stage('Build Docker') {
            steps {
                bat '''
                    echo Building Docker for PR...
                    docker build -t booking-app:pr-%BUILD_NUMBER% .
                    echo ✅ PR Docker built
                '''
            }
        }
        
        // STAGE 3: Test
        stage('Test') {
            steps {
                bat '''
                    echo Testing PR build...
                    docker run -d --name pr-test-%BUILD_NUMBER% -p 8082:80 booking-app:pr-%BUILD_NUMBER%
                    ping 127.0.0.1 -n 11 > nul
                    
                    curl -f http://localhost:8082
                    if errorlevel 1 (
                        echo ❌ PR TEST FAILED
                        exit /b 1
                    )
                    
                    echo ✅ PR TEST PASSED
                    
                    docker stop pr-test-%BUILD_NUMBER%
                    docker rm pr-test-%BUILD_NUMBER%
                '''
            }
        }
        
        // STAGE 4: Archive
        stage('Archive') {
            steps {
                bat '''
                    mkdir artifacts 2>nul
                    echo "PR Build %BUILD_NUMBER% - PASSED" > artifacts\result.txt
                    echo "Date: %DATE% %TIME%" >> artifacts\result.txt
                '''
                archiveArtifacts artifacts: 'artifacts/**/*'
            }
        }
        
        // STAGE 5: Cleanup
        stage('Cleanup') {
            steps {
                bat '''
                    echo Cleaning up...
                    docker stop pr-test-%BUILD_NUMBER% 2>nul || echo OK
                    docker rm pr-test-%BUILD_NUMBER% 2>nul || echo OK
                    echo ✅ Cleanup done
                '''
            }
        }
    }
    
    post {
        success {
            echo '✅ PR PIPELINE SUCCESS - Ready for merge!'
        }
        failure {
            echo '❌ PR PIPELINE FAILED'
        }
    }
}
           
